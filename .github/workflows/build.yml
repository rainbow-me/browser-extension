name: CI

on:
  pull_request:
  merge_group:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  # INSTALL DEPS
  install:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"
      - name: Enable Corepack
        run: corepack enable
      - name: Install deps via Yarn
        run: |
          yarn install --immutable
          yarn setup
      - name: Check for frozen lockfile
        run: yarn check-lockfile
      - name: Zip node_modules and yarn state
        run: tar czf yarn_node_modules.tar.gz node_modules/ .yarn/install-state.gz
      - name: Upload deps artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yarn_node_modules.tar.gz
          path: yarn_node_modules.tar.gz

  # BUILD THE EXTENSION
  build:
    runs-on: ubuntu-latest
    needs: [install]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"
      - name: Enable Corepack
        run: corepack enable
      - name: Download deps cache artifacts
        uses: actions/download-artifact@v4
        with:
          name: yarn_node_modules.tar.gz
      - name: Unzip node_modules and yarn state
        run: tar xzf yarn_node_modules.tar.gz
      - uses: actions/checkout@v4
        with:
          repository: "rainbow-me/browser-extension-env"
          token: ${{ secrets.ORG_ACCESS_TOKEN }}
          path: tmp
      - name: Copy dotenv
        run: cat tmp/dotenv >> .env && rm -rf tmp
      - name: Set IS_TESTING=true
        run: |
          sed -i 's/IS_TESTING.*/IS_TESTING=true/g' .env
      - name: Yarn setup again
        run: yarn setup
      - name: Build the extension
        run: yarn build:webpack
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rainbowbx-${{ github.sha }}
          path: build/
      - name: Remove old screenshots
        run: rm -rf screenshots/*
  # FIREFOX TESTS
  # firefox-e2e-parallel:
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 18
  #   needs: [build]
  #   env:
  #     DISPLAY: :0
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/firefoxTestsSetup
  #       with:
  #         gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
  #     - name: Run e2e parallel (Firefox)
  #       id: FFE2eParallel
  #       continue-on-error: true
  #       run: |
  #           export BROWSER=firefox
  #           export OS=linux
  #           export FIREFOX_BIN="$(pwd)/firefox/firefox"
  #           export MAX_RETRIES=3
  #           yarn firefox:manifest && yarn firefox:zip
  #           yarn e2e:parallel
  #     - name: Upload deps artifacts
  #       if: steps.FFE2eParallel.outcome == 'failure'
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: screenshots
  #         path: screenshots/
  #     - name: Fail if any tests failed
  #       if: steps.FFE2eParallel.outcome == 'failure'
  #       run: exit 1
  # firefox-e2e-swap:
  #   runs-on: swaps-runner-bx
  #   timeout-minutes: 25
  #   needs: [build]
  #   env:
  #     DISPLAY: :0
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/firefoxTestsSetup
  #       with:
  #         gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
  #     - name: Run e2e Swap (Firefox)
  #       id: FFE2eSwap
  #       continue-on-error: true
  #       run: |
  #         export BROWSER=firefox
  #         export OS=linux
  #         export FIREFOX_BIN="$(pwd)/firefox/firefox"
  #         export MAX_RETRIES=3
  #         yarn firefox:manifest && yarn firefox:zip
  #         yarn e2e:swap
  #     - name: Upload deps artifacts
  #       if: steps.FFE2eSwap.outcome == 'failure'
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: screenshots
  #         path: screenshots/
  #     - name: Fail if any tests failed
  #       if: steps.FFE2eSwap.outcome == 'failure'
  #       run: exit 1
  # firefox-e2e-send:
  #   runs-on: send-runner-bx
  #   timeout-minutes: 16
  #   needs: [build]
  #   env:
  #     DISPLAY: :0
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/firefoxTestsSetup
  #       with:
  #         gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
  #     - name: Run e2e Send (Firefox)
  #       id: FFE2eSend
  #       continue-on-error: true
  #       run: |
  #           export BROWSER=firefox
  #           export OS=linux
  #           export FIREFOX_BIN="$(pwd)/firefox/firefox"
  #           export MAX_RETRIES=3
  #           yarn firefox:manifest && yarn firefox:zip
  #           yarn e2e:send
  #     - name: Upload deps artifacts
  #       if: steps.FFE2eSend.outcome == 'failure'
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: screenshots
  #         path: screenshots/
  #     - name: Fail if any tests failed
  #       if: steps.FFE2eSend.outcome == 'failure'
  #       run: exit 1
  # firefox-e2e-dappInteractions:
  #   runs-on: dapp-interactions-runner-bx
  #   timeout-minutes: 25
  #   needs: [build]
  #   env:
  #     DISPLAY: :0
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/firefoxTestsSetup
  #       with:
  #         gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
  #     - name: Run e2e Dapp Interactions (Firefox)
  #       id: FFE2eDappInteractions
  #       continue-on-error: true
  #       run: |
  #         export BROWSER=firefox
  #         export OS=linux
  #         export FIREFOX_BIN="$(pwd)/firefox/firefox"
  #         export MAX_RETRIES=3
  #         yarn firefox:manifest && yarn firefox:zip
  #         yarn e2e:dappInteractions
  #     - name: Upload deps artifacts
  #       if: steps.FFE2eDappInteractions.outcome == 'failure'
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: screenshots
  #         path: screenshots/
  #     - name: Fail if any tests failed
  #       if: steps.FFE2eDappInteractions.outcome == 'failure'
  #       run: exit 1
  # CHROME TESTS
  chrome-e2e-parallel:
    runs-on: beefy-runner-bx
    timeout-minutes: 18
    needs: [build]
    env:
      DISPLAY: :0
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/chromeTestsSetup
        with:
          gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
      - name: Run e2e parallel (Chrome)
        id: ChromeE2EParallel
        continue-on-error: true
        run: |
          export BROWSER=chrome
          export OS=linux
          export CHROMIUM_BIN=$(find chrome -type f -name 'chrome')
          export MAX_RETRIES=3
          yarn e2e:parallel
      - name: Upload deps artifacts
        if: steps.ChromeE2EParallel.outcome == 'failure'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-chrome-e2e-parallel
          path: screenshots/
      - name: Fail if any tests failed
        if: steps.ChromeE2EParallel.outcome == 'failure'
        run: exit 1
  chrome-e2e-swap:
    runs-on: swaps-runner-bx
    timeout-minutes: 25
    needs: [build]
    env:
      DISPLAY: :0
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/chromeTestsSetup
        with:
          gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
      - name: Run e2e swap (Chrome)
        id: ChromeE2ESwaps
        continue-on-error: true
        run: |
          export BROWSER=chrome
          export OS=linux
          export CHROMIUM_BIN=$(find chrome -type f -name 'chrome')
          export MAX_RETRIES=3
          yarn e2e:swap
      - name: Upload deps artifacts
        if: steps.ChromeE2ESwaps.outcome == 'failure'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-chrome-e2e-swap
          path: screenshots/
      - name: Fail if any tests failed
        if: steps.ChromeE2ESwaps.outcome == 'failure'
        run: exit 1
  chrome-e2e-send:
    runs-on: send-runner-bx
    timeout-minutes: 16
    needs: [build]
    env:
      DISPLAY: :0
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/chromeTestsSetup
        with:
          gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
      - name: Run e2e send (Chrome)
        id: ChromeE2ESend
        continue-on-error: true
        run: |
          export BROWSER=chrome
          export OS=linux
          export CHROMIUM_BIN=$(find chrome -type f -name 'chrome')
          export MAX_RETRIES=3
          yarn e2e:send
      - name: Upload deps artifacts
        if: steps.ChromeE2ESend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-chrome-e2e-send
          path: screenshots/
      - name: Fail if any tests failed
        if: steps.ChromeE2ESend.outcome == 'failure'
        run: exit 1
  chrome-optimism-e2e-send:
    runs-on: send-runner-bx
    timeout-minutes: 25
    needs: [build]
    env:
      DISPLAY: :0
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/chromeTestsSetup
        with:
          gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
      - name: Run Optimism e2e send (Chrome)
        id: ChromeOpE2ESend
        continue-on-error: true
        run: |
          export BROWSER=chrome
          export OS=linux
          export CHROMIUM_BIN=$(find chrome -type f -name 'chrome')
          export MAX_RETRIES=3
          yarn e2e:send:optimism
      - name: Upload deps artifacts
        if: steps.ChromeOpE2ESend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-chrome-optimism-e2e-send
          path: screenshots/
      - name: Fail if any tests failed
        if: steps.ChromeOpE2ESend.outcome == 'failure'
        run: exit 1
  chrome-e2e-dappInteractions:
    runs-on: beefy-runner-bx
    timeout-minutes: 25
    needs: [build]
    env:
      DISPLAY: :0
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/chromeTestsSetup
        with:
          gh-access-token: ${{ secrets.ORG_ACCESS_TOKEN }}
      - name: Run e2e dappInteractions (Chrome)
        id: ChromeE2EDappInteractions
        continue-on-error: true
        run: |
          export BROWSER=chrome
          export OS=linux
          export CHROMIUM_BIN=$(find chrome -type f -name 'chrome')
          export MAX_RETRIES=3
          yarn e2e:dappInteractions
      - name: Upload deps artifacts
        if: steps.ChromeE2EDappInteractions.outcome == 'failure'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-chrome-e2e-dappInteractions
          path: screenshots/
      - name: Fail if any tests failed
        if: steps.ChromeE2EDappInteractions.outcome == 'failure'
        run: exit 1

  # UNIT TESTS
  unit-tests:
    runs-on: ubuntu-latest
    needs: [install]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"
      - name: Enable Corepack
        run: corepack enable
      - name: Download deps cache artifacts
        uses: actions/download-artifact@v4
        with:
          name: yarn_node_modules.tar.gz
      - name: Unzip node_modules and yarn state
        run: tar xzf yarn_node_modules.tar.gz
      - name: Install rust
        uses: moonrepo/setup-rust@v1.2.1
        with:
          channel: stable
          profile: minimal
      - name: Install Anvil
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      - uses: actions/checkout@v4
        with:
          repository: "rainbow-me/browser-extension-env"
          token: ${{ secrets.ORG_ACCESS_TOKEN }}
          path: tmp
      - name: Copy dotenv
        run: cat tmp/dotenv >> .env && rm -rf tmp
      - name: Set IS_TESTING=true
        run: |
          sed -i 's/IS_TESTING.*/IS_TESTING=true/g' .env
      - name: Run unit tests
        run: yarn test

  # LINT, TYPECHECK, AUDIT
  ci-checks:
    runs-on: ubuntu-latest
    needs: [install]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"
      - name: Enable Corepack
        run: corepack enable
      - name: Download deps cache artifacts
        uses: actions/download-artifact@v4
        with:
          name: yarn_node_modules.tar.gz
      - name: Unzip node_modules and yarn state
        run: tar xzf yarn_node_modules.tar.gz
      - name: DS Setup
        run: yarn ds:install
      - name: Lint
        run: yarn lint
      - name: Audit CI
        run: yarn audit:ci
      - name: Check types
        run: yarn typecheck

  # BUNDLE SIZE CHECK
  bundlewatch:
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      statuses: write # Needed to post status checks if using GitHub token
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.17.0"
      - name: Enable Corepack
        run: corepack enable
      - name: Download deps cache artifacts
        uses: actions/download-artifact@v4
        with:
          name: yarn_node_modules.tar.gz
      - name: Unzip node_modules and yarn state
        run: tar xzf yarn_node_modules.tar.gz
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: rainbowbx-${{ github.sha }}
          path: build/
      - name: Check bundle sizes and generate report
        env:
          CI_REPO_OWNER: ${{ github.repository_owner }}
          CI_REPO_NAME: ${{ github.event.repository.name }}
          CI_COMMIT_SHA: ${{ github.sha }}
          CI_BRANCH: ${{ github.ref_name }}
        run: |
          # Disable exit-on-error to ensure summary is always written, even if bundlewatch fails
          # GitHub Actions uses 'set -e' by default, which would exit immediately on command failure
          set +e

          # Run bundlewatch and capture both output and exit code
          # Using command substitution with 2>&1 to capture both stdout and stderr
          BUNDLEWATCH_OUTPUT=$(yarn bundlewatch 2>&1)
          BUNDLEWATCH_EXIT_CODE=$?

          # Echo output to job logs for visibility
          echo "$BUNDLEWATCH_OUTPUT"

          # Generate summary report - this will always execute due to 'set +e'
          # GITHUB_STEP_SUMMARY is a file path provided by GitHub Actions for step summaries
          {
            echo "## üì¶ Bundle Size Report"
            echo ""

            # Extract and display the result breakdown URL if it exists
            if [ -n "$BUNDLEWATCH_OUTPUT" ]; then
              # Look specifically for the bundlewatch result URL (ja2r7.app.goo.gl domain)
              BREAKDOWN_URL=$(echo "$BUNDLEWATCH_OUTPUT" | grep -A1 "Result breakdown at:" | grep -oE "https://ja2r7\.app\.goo\.gl/[a-zA-Z0-9]+" | head -1 || true)
              if [ -n "$BREAKDOWN_URL" ]; then
                echo "üìä **[View detailed breakdown]($BREAKDOWN_URL)**"
                echo ""
              fi

              # Check overall status
              if echo "$BUNDLEWATCH_OUTPUT" | grep -q "bundlewatch PASS"; then
                echo "‚úÖ **Status: PASS** - All bundles are within size limits"
              elif echo "$BUNDLEWATCH_OUTPUT" | grep -q "bundlewatch FAIL"; then
                echo "‚ùå **Status: FAIL** - Some bundles exceed size limits"
                echo ""
                echo "‚ö†Ô∏è **Action Required:** Please review the bundle size increases. If the increases are expected and justified, update the limits in \`.bundlewatchrc.json\`"
              fi

              # Extract total size change if present
              TOTAL_CHANGE=$(echo "$BUNDLEWATCH_OUTPUT" | grep -oE "Everything is in check \([^)]+\)" || true)
              if [ -n "$TOTAL_CHANGE" ]; then
                echo "üìà $TOTAL_CHANGE"
              fi
              echo ""

              echo "| File | Size | Limit | Status |"
              echo "|------|------|-------|--------|"

              # Parse bundlewatch output and format as markdown table
              # Using process substitution to avoid subshell issues with pipes
              echo "$BUNDLEWATCH_OUTPUT" | grep -E "PASS|FAIL" | grep "./build/" | while IFS= read -r line || [ -n "$line" ]; do
                if [[ $line == *"PASS"* ]]; then
                  STATUS="‚úÖ"
                else
                  STATUS="‚ùå"
                fi
                FILE=$(echo "$line" | sed -E 's/.*(\.\/build\/[^:]+):.*/\1/' || echo "unknown")
                SIZE=$(echo "$line" | sed -E 's/.*: ([0-9.]+[KMB]+).*/\1/' || echo "unknown")
                LIMIT=$(echo "$line" | sed -E 's/.*< ([0-9.]+[KMB]+).*/\1/' || echo "unknown")
                echo "| \`${FILE##*/}\` | **${SIZE}** | ${LIMIT} | ${STATUS} |"
              done
            else
              echo "‚ö†Ô∏è No bundlewatch output found"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # Exit with failure if bundlewatch failed (after writing summary)
          # Check both exit code and output for "bundlewatch FAIL" as a safety measure
          if [ "$BUNDLEWATCH_EXIT_CODE" -ne 0 ] || echo "$BUNDLEWATCH_OUTPUT" | grep -q "bundlewatch FAIL"; then
            exit 1
          fi

  cleanup:
    runs-on: ubuntu-latest
    needs:
      [
        chrome-e2e-parallel,
        chrome-e2e-swap,
        chrome-e2e-send,
        chrome-e2e-dappInteractions,
        chrome-optimism-e2e-send,
        unit-tests,
        ci-checks,
        bundlewatch,
      ]
    steps:
      - uses: geekyeggo/delete-artifact@v5
        with:
          name: yarn_node_modules.tar.gz
          failOnError: false
      - uses: geekyeggo/delete-artifact@v5
        with:
          name: screenshots-*
          failOnError: false
