name: CI

on: [pull_request, workflow_dispatch]

jobs:
  build:
    env:
      DISPLAY: :0
    runs-on: ubuntu-latest
    concurrency: 
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v2
        with:
          node-version: "14.20.1"
          cache: 'yarn'
      - name: Install deps via Yarn
        run: yarn setup
      - name: Check for frozen lockfile
        run: yarn check-lockfile
      - name: Audit CI
        run:  yarn audit:ci
      - name: Lint
        run: yarn lint
      - name: Check types
        run: yarn typecheck
      - name: Build the extension with LavaMoat
        run: yarn build
      - uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: 'stable'
      - name: Setup Brave browser
        run: |
          sudo apt install apt-transport-https curl
          sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg arch=amd64] https://brave-browser-apt-release.s3.brave.com/ stable main"|sudo tee /etc/apt/sources.list.d/brave-browser-release.list
          sudo apt update
          sudo apt install brave-browser
      - name: Setup xvfb
        run: |
          sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xinput0 libxcb-xfixes0
          # start xvfb in the background
          sudo /usr/bin/Xvfb $DISPLAY -screen 0 1280x1024x24 &
      - name: Run e2e (Chrome)
        run: |
          yarn test:linux:chrome
      - name: Run e2e (Brave)
        run: |
          yarn test:linux:brave
      - name: Pack extension
        run: yarn zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v1
        with:
          name: rainbowbx-${{ github.sha }}.zip
          path: rainbowbx.zip


          
